#!/usr/bin/python

#The MIT License (MIT)
#
#Copyright (c) 2015 Sam Yaple
#
#Permission is hereby granted, free of charge, to any person obtaining a copy
#of this software and associated documentation files (the "Software"), to deal
#in the Software without restriction, including without limitation the rights
#to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#copies of the Software, and to permit persons to whom the Software is
#furnished to do so, subject to the following conditions:
#
#The above copyright notice and this permission notice shall be included in all
#copies or substantial portions of the Software.
#
#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
#SOFTWARE.

DOCUMENTATION = '''
---
module: ceph_osd_list
version_added: 1.8.2
short_description: Very hacked, very targeted module
description:
     - This will return a list of all devices with a GPT name of 'CEPH_OSD' and
       a filesystem uuid. This is targeted until a more generic module is
       written.
options:
  partition_name:
    description:
      - Partition name
    default: 'CEPH_OSD'
    type: bool
author: Sam Yaple
'''

EXAMPLES = '''
- hosts: ceph-osd
  tasks:
    - name: Return all valid formated devices wit hthe name CEPH_OSD
      ceph_osd_list:
      register: osds
'''

import sys
import os
import re
from ConfigParser import ConfigParser

ESCAPE = '_'
EOL = '9' + ESCAPE

MAPPING = {
    '/': '0',
    '-': '1',
    '_': '2',
    '.': '3',
    ' ': '4',
}

REV_MAPPING = {v: k for k, v in MAPPING.items()}

def sanatize(name):
    name = name.replace(ESCAPE, ESCAPE + MAPPING[ESCAPE])

    for k in MAPPING:
        if k == ESCAPE:
            continue

        name = name.replace(k, ESCAPE + MAPPING[k])

#    for match in re.findall(DELIM + '[0-9]' + DELIM, name):
#        name = name.replace(MAPPING[match.split(DELIM)], match)

    return name

def convert_name(prefix, filename, section, key):
    name = prefix + ESCAPE + EOL
    name += sanatize(filename)
    name += ESCAPE + EOL
    name += sanatize(section)
    name += ESCAPE + EOL
    name += sanatize(key)

    return name

def main():
    module = AnsibleModule(
        argument_spec = dict(
            config_files = dict(required=True, type='list'),
            prefix = dict(default='YAODU', type='str'),
        ),
        supports_check_mode = True
    )

    config_files = module.params.get('config_files')
    prefix = module.params.get('prefix')

    try:
        env = 'dummy=variable'

        for config_file in config_files:
            with open(config_file, 'rb') as f:
                config = ConfigParser()
                config.readfp(f)
                sections = ["DEFAULT"] + config.sections()

                for section in sections:
                    for item in config.items(section):
                        env += ','
                        env += convert_name(prefix, config_file, section, item[0])
                        env += '='
                        env += item[1]

        module.exit_json(env=env)

    except Exception as e:
        module.exit_json(failed=True, msg=repr(e))

# import module snippets
from ansible.module_utils.basic import *

if __name__ == '__main__':
    main()
